{% extends 'frontend/base.html' %}
{% load custom_filters %}

{% block title %}Reports & Analytics - IT Management Platform{% endblock %}

{% block extra_head %}
<style>
/* Dark mode overrides for Reports page */
html.dark .text-3xl,
html.dark .text-4xl {
    color: #f3f4f6;
}
html.dark .text-gray-600 {
    color: #9ca3af !important;
}
html.dark .text-gray-700 {
    color: #d1d5db !important;
}
html.dark .text-gray-900 {
    color: #f3f4f6 !important;
}
html.dark .text-gray-500 {
    color: #9ca3af !important;
}
html.dark .bg-gray-200 {
    background-color: #374151 !important;
}
html.dark .bg-gray-100 {
    background-color: #374151 !important;
}
html.dark .bg-gray-50 {
    background-color: #1f2937 !important;
}
/* Priority distribution card backgrounds */
html.dark .border-red-200 {
    border-color: #7f1d1d !important;
    background-color: rgba(127, 29, 29, 0.3) !important;
}
html.dark .border-orange-200 {
    border-color: #92400e !important;
    background-color: rgba(146, 64, 14, 0.3) !important;
}
html.dark .border-blue-200 {
    border-color: #1e40af !important;
    background-color: rgba(30, 64, 175, 0.3) !important;
}
html.dark .border-gray-200 {
    border-color: #4b5563 !important;
    background-color: rgba(75, 85, 99, 0.3) !important;
}
/* Priority text colors in dark mode */
html.dark .text-red-600 {
    color: #fca5a5 !important;
}
html.dark .text-orange-600 {
    color: #fdba74 !important;
}
html.dark .text-blue-600 {
    color: #93c5fd !important;
}
html.dark .text-gray-600 {
    color: #d1d5db !important;
}
/* Status badge backgrounds in dark mode */
html.dark .bg-blue-100 {
    background-color: #1e3a8a !important;
}
html.dark .text-blue-800 {
    color: #93c5fd !important;
}
html.dark .bg-yellow-100 {
    background-color: #78350f !important;
}
html.dark .text-yellow-800 {
    color: #fcd34d !important;
}
html.dark .bg-green-100 {
    background-color: #064e3b !important;
}
html.dark .text-green-800 {
    color: #86efac !important;
}
html.dark .bg-gray-100 {
    background-color: #374151 !important;
}
html.dark .text-gray-800 {
    color: #f3f4f6 !important;
}
html.dark .bg-orange-100 {
    background-color: #7c2d12 !important;
}
html.dark .text-orange-800 {
    color: #fdba74 !important;
}
/* Table styles in dark mode */
html.dark table thead.bg-gray-100 {
    background-color: #374151 !important;
}
html.dark table thead.bg-gray-100 th {
    color: #f3f4f6;
}
html.dark table tbody.divide-y.divide-gray-200 td {
    color: #f3f4f6;
}
html.dark table tbody.divide-y.divide-gray-200 td.text-gray-600 {
    color: #9ca3af !important;
}
/* Icon background circles */
html.dark .bg-blue-100 {
    background-color: rgba(59, 130, 246, 0.2) !important;
}
html.dark .bg-green-100 {
    background-color: rgba(34, 197, 94, 0.2) !important;
}
html.dark .bg-yellow-100 {
    background-color: rgba(234, 179, 8, 0.2) !important;
}
html.dark .bg-purple-100 {
    background-color: rgba(168, 85, 247, 0.2) !important;
}
html.dark .bg-red-100 {
    background-color: rgba(239, 68, 68, 0.2) !important;
}
/* Priority distribution cards */
html.dark .p-4.rounded-lg.border-2 {
    background-color: #1f2937 !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-2">Reports & Analytics</h1>
            <p class="text-gray-600">System statistics, activity monitoring, and audit reports</p>
        </div>
        <div class="flex flex-wrap gap-2">
            <button onclick="exportReport('pdf')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition flex items-center gap-2">
                <i class="fas fa-file-pdf"></i> PDF
            </button>
            <button onclick="exportReport('csv')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                <i class="fas fa-file-csv"></i> CSV
            </button>
            <button onclick="exportReport('excel')" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition flex items-center gap-2">
                <i class="fas fa-file-excel"></i> Excel
            </button>
            <button onclick="window.print()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition flex items-center gap-2">
                <i class="fas fa-print"></i> Print
            </button>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
        <!-- Total Assets -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Total Assets</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2">{{ total_assets }}</p>
                </div>
                <div class="bg-blue-100 rounded-full p-3">
                    <i class="fas fa-desktop text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Active Projects -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Active Projects</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2">{{ active_projects }}</p>
                </div>
                <div class="bg-green-100 rounded-full p-3">
                    <i class="fas fa-project-diagram text-green-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Open Tickets -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Open Tickets</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2">{{ open_tickets }}</p>
                </div>
                <div class="bg-yellow-100 rounded-full p-3">
                    <i class="fas fa-ticket-alt text-yellow-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Active Users -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Active Users</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2">{{ active_users }}</p>
                </div>
                <div class="bg-purple-100 rounded-full p-3">
                    <i class="fas fa-users text-purple-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Security Events -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Security Events (7d)</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2">{{ recent_security_events }}</p>
                </div>
                <div class="bg-red-100 rounded-full p-3">
                    <i class="fas fa-shield-alt text-red-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Asset Status Distribution - Live Database Values -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                <i class="fas fa-chart-pie text-blue-500"></i>
                Asset Status Distribution
            </h3>
            <div class="space-y-4">
                {% if asset_status_distribution %}
                    {% for status, data in asset_status_distribution.items %}
                    {% with total=total_assets|default:1 %}
                    {% with percent=data.count|add:0|divide:total|multiply:100 %}
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700 flex items-center gap-2">
                                {% if status == 'ACTIVE' %}
                                    <span class="w-3 h-3 rounded-full bg-green-500"></span>
                                {% elif status == 'INACTIVE' %}
                                    <span class="w-3 h-3 rounded-full bg-gray-400"></span>
                                {% elif status == 'MAINTENANCE' %}
                                    <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                                {% elif status == 'RETIRED' %}
                                    <span class="w-3 h-3 rounded-full bg-red-500"></span>
                                {% else %}
                                    <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                                {% endif %}
                                {{ data.label|default:status }}
                            </span>
                            <span class="text-sm font-bold text-gray-900">{{ data.count }} ({{ percent|floatformat:1 }}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="h-3 rounded-full {% if status == 'ACTIVE' %}bg-green-500{% elif status == 'INACTIVE' %}bg-gray-400{% elif status == 'MAINTENANCE' %}bg-yellow-500{% elif status == 'RETIRED' %}bg-red-500{% else %}bg-blue-500{% endif %}" 
                                 style="width: {{ percent|floatformat:0 }}%"></div>
                        </div>
                    </div>
                    {% endwith %}
                    {% endwith %}
                    {% endfor %}
                {% else %}
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-chart-pie text-4xl mb-2 text-gray-300"></i>
                        <p>No asset data available</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Ticket Status Distribution - Live Database Values -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                <i class="fas fa-chart-bar text-green-500"></i>
                Ticket Status Distribution
            </h3>
            <div class="space-y-4">
                {% if tickets_by_status and total_tickets > 0 %}
                    {% for status, data in tickets_by_status.items %}
                    {% with percent=data.count|add:0|divide:total_tickets|multiply:100 %}
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700 flex items-center gap-2">
                                {% if status == 'OPEN' or status == 'NEW' %}
                                    <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                                {% elif status == 'IN_PROGRESS' %}
                                    <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                                {% elif status == 'RESOLVED' %}
                                    <span class="w-3 h-3 rounded-full bg-green-500"></span>
                                {% elif status == 'CLOSED' %}
                                    <span class="w-3 h-3 rounded-full bg-gray-500"></span>
                                {% else %}
                                    <span class="w-3 h-3 rounded-full bg-purple-500"></span>
                                {% endif %}
                                {{ data.label|default:status }}
                            </span>
                            <span class="text-sm font-bold text-gray-900">{{ data.count }} ({{ percent|floatformat:1 }}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="h-3 rounded-full {% if status == 'OPEN' or status == 'NEW' %}bg-blue-500{% elif status == 'IN_PROGRESS' %}bg-yellow-500{% elif status == 'RESOLVED' %}bg-green-500{% elif status == 'CLOSED' %}bg-gray-500{% else %}bg-purple-500{% endif %}" 
                                 style="width: {{ percent|floatformat:0 }}%"></div>
                        </div>
                    </div>
                    {% endwith %}
                    {% endfor %}
                {% else %}
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-chart-bar text-4xl mb-2 text-gray-300"></i>
                        <p>No ticket data available</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Recent Tickets Report with Audit Information -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            <i class="fas fa-ticket-alt text-red-500"></i>
            Recent Tickets
        </h3>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-100 border-b-2 border-gray-300">
                    <tr>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Ticket ID</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Title</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Status</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Priority</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Created By</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Created Date</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Last Modified By</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for ticket in recent_tickets %}
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">
                            <a href="{% url 'frontend:ticket-detail' ticket.id %}" class="text-blue-600 hover:text-blue-800 hover:underline">
                                #{{ ticket.id }}
                            </a>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">{{ ticket.title|truncatewords:5 }}</td>
                        <td class="px-6 py-4 text-sm">
                            <span class="px-3 py-1 rounded-full text-xs font-medium 
                                {% if ticket.status == 'NEW' %}bg-blue-100 text-blue-800
                                {% elif ticket.status == 'OPEN' %}bg-blue-100 text-blue-800
                                {% elif ticket.status == 'IN_PROGRESS' %}bg-yellow-100 text-yellow-800
                                {% elif ticket.status == 'RESOLVED' %}bg-green-100 text-green-800
                                {% elif ticket.status == 'CLOSED' %}bg-gray-100 text-gray-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ ticket.get_status_display|default:ticket.status }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <span class="px-3 py-1 rounded-full text-xs font-medium 
                                {% if ticket.priority == 'CRITICAL' %}bg-red-100 text-red-800
                                {% elif ticket.priority == 'HIGH' %}bg-orange-100 text-orange-800
                                {% elif ticket.priority == 'MEDIUM' %}bg-blue-100 text-blue-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ ticket.get_priority_display|default:ticket.priority }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">
                            {% if ticket.created_by and ticket.created_by.id %}
                            <a href="{% url 'frontend:user-detail' ticket.created_by.id %}" class="text-blue-600 hover:text-blue-800">
                                {{ ticket.created_by.username }}
                            </a>
                            {% else %}
                            System
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">{{ ticket.created_at|date:"M d, Y H:i" }}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">
                            {% if ticket.updated_by and ticket.updated_by.id %}
                            <a href="{% url 'frontend:user-detail' ticket.updated_by.id %}" class="text-blue-600 hover:text-blue-800">
                                {{ ticket.updated_by.username }}
                            </a>
                            {% elif ticket.created_by and ticket.created_by.id %}
                            <a href="{% url 'frontend:user-detail' ticket.created_by.id %}" class="text-blue-600 hover:text-blue-800">
                                {{ ticket.created_by.username }}
                            </a>
                            {% else %}
                            System
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-ticket-alt text-3xl mb-2 text-gray-300"></i>
                            <p>No tickets found</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recent Activity Logs with Audit-Grade Details -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            <i class="fas fa-history text-indigo-500"></i>
            Recent Activity Logs (Audit Trail)
        </h3>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-100 border-b-2 border-gray-300">
                    <tr>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Timestamp</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Actor</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Action</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Entity</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">Changes (Before â†’ After)</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-900">IP Address</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for activity in recent_activities %}
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">
                            {{ activity.timestamp|date:"M d, Y H:i:s" }}
                        </td>
                        <td class="px-4 py-3 text-sm">
                            {% if activity.actor.id %}
                            <a href="{% url 'frontend:user-detail' activity.actor.id %}" class="flex items-center gap-2 text-blue-600 hover:text-blue-800">
                                <i class="fas fa-user text-gray-400"></i>
                                {{ activity.actor.username }}
                            </a>
                            {% else %}
                            <span class="flex items-center gap-2 text-gray-500">
                                <i class="fas fa-cog text-gray-400"></i>
                                System
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <span class="flex items-center gap-2 {{ activity.action_color }}">
                                <i class="fas {{ activity.action_icon }}"></i>
                                {{ activity.action_label }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            {% if activity.entity.url != '#' %}
                            <a href="{{ activity.entity.url }}" class="flex items-center gap-2 text-blue-600 hover:text-blue-800">
                                <span class="px-2 py-1 bg-gray-100 rounded text-xs font-medium">
                                    {{ activity.entity.type }}
                                </span>
                                {% if activity.entity.name %}
                                <span class="truncate max-w-xs">{{ activity.entity.name }}</span>
                                {% endif %}
                            </a>
                            {% else %}
                            <span class="flex items-center gap-2 text-gray-500">
                                <span class="px-2 py-1 bg-gray-100 rounded text-xs font-medium">
                                    {{ activity.entity.type }}
                                </span>
                                {% if activity.entity.name %}
                                <span class="truncate max-w-xs">{{ activity.entity.name }}</span>
                                {% endif %}
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-sm">
                            {% if activity.changes_summary %}
                            <span class="text-gray-700">
                                {{ activity.changes_summary }}
                            </span>
                            {% else %}
                            <span class="text-gray-400 italic">No changes</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-500 font-mono text-xs">
                            {{ activity.ip_address|default:"-" }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-list-alt text-3xl mb-2 text-gray-300"></i>
                            <p>No activity logs found</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Ticket Priority Distribution -->
    {% if tickets_by_priority %}
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            <i class="fas fa-exclamation-circle text-orange-500"></i>
            Ticket Priority Distribution
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            {% for priority, data in tickets_by_priority.items %}
            <div class="p-4 rounded-lg border-2 
                {% if priority == 'CRITICAL' %}border-red-200 bg-red-50
                {% elif priority == 'HIGH' %}border-orange-200 bg-orange-50
                {% elif priority == 'MEDIUM' %}border-blue-200 bg-blue-50
                {% else %}border-gray-200 bg-gray-50{% endif %}">
                <div class="text-center">
                    <p class="text-3xl font-bold 
                        {% if priority == 'CRITICAL' %}text-red-600
                        {% elif priority == 'HIGH' %}text-orange-600
                        {% elif priority == 'MEDIUM' %}text-blue-600
                        {% else %}text-gray-600{% endif %}">
                        {{ data.count }}
                    </p>
                    <p class="text-sm font-medium text-gray-700 mt-1">{{ data.label|default:priority }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Export Hidden Form -->
<form id="exportForm" method="POST" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="export_format" id="exportFormat">
</form>

<script>
// Export functionality
function exportReport(format) {
    const form = document.getElementById('exportFormat');
    form.value = format;
    form.action = '/reports/export/';
    form.submit();
}

// Add number formatting filter
function divide(a, b) {
    return b ? a / b : 0;
}

function multiply(a, b) {
    return a * b;
}

// Auto-refresh statistics every 60 seconds
setInterval(function() {
    console.log('Reports page auto-refresh triggered');
    // Optionally reload page or fetch new data
    // location.reload();
}, 60000);
</script>
{% endblock %}

