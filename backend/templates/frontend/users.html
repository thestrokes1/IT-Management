{% extends 'frontend/base.html' %}
{% load custom_filters %}

{% block title %}Users Management - IT Management Platform{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 sm:py-8">
    <div class="mb-6 sm:mb-8">
        <h1 class="text-2xl sm:text-4xl font-bold text-gray-900 mb-2">Users Management</h1>
        <p class="text-xs sm:text-base text-gray-600">Manage users and their roles in the system</p>
    </div>

    <!-- Add User Button -->
    <div class="mb-6">
        <a href="{% url 'frontend:create-user' %}" class="inline-block bg-blue-600 text-white px-4 sm:px-6 py-2 sm:py-3 text-sm sm:text-base rounded-lg hover:bg-blue-700 transition">
            + Add New User
        </a>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-6">
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 sm:gap-4">
            <div>
                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Search Users</label>
                <input type="text" id="searchUsers" placeholder="Search by name..." class="w-full px-3 sm:px-4 py-2 text-xs sm:text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div>
                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Role</label>
                <select id="roleFilter" class="w-full px-3 sm:px-4 py-2 text-xs sm:text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">All Roles</option>
                    {% for role_code, role_name in role_choices %}
                    <option value="{{ role_name }}">{{ role_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">Status</label>
                <select id="statusFilter" class="w-full px-3 sm:px-4 py-2 text-xs sm:text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-xs sm:text-sm">
                <thead class="bg-gray-100 border-b-2 border-gray-300">
                    <tr>
                        <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-semibold text-gray-900">Username</th>
                        <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-semibold text-gray-900 hidden sm:table-cell">Email</th>
                        <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-semibold text-gray-900 hidden md:table-cell">Full Name</th>
                        <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-semibold text-gray-900">Role</th>
                        <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-semibold text-gray-900 hidden lg:table-cell">Status</th>
                        <th class="px-3 sm:px-6 py-2 sm:py-3 text-left font-semibold text-gray-900">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% if users %}
                        {% for user in users %}
                        {% with user_perms=permissions_map|get_item:user.id %}
                        <tr class="hover:bg-gray-50 transition user-row" data-id="{{ user.id }}">
                            <td class="px-3 sm:px-6 py-2 sm:py-4 font-medium text-gray-900">{{ user.username }}</td>
                            <td class="px-3 sm:px-6 py-2 sm:py-4 text-gray-600 hidden sm:table-cell">{{ user.email }}</td>
                            <td class="px-3 sm:px-6 py-2 sm:py-4 text-gray-600 hidden md:table-cell">{{ user.first_name }} {{ user.last_name }}</td>
                            <td class="px-3 sm:px-6 py-2 sm:py-4">
                                <span class="px-2 sm:px-3 py-1 rounded-full text-xs font-medium {% if user.role == 'ADMIN' %}bg-red-100 text-red-800{% elif user.role == 'MANAGER' %}bg-blue-100 text-blue-800{% elif user.role == 'TECHNICIAN' %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ user.role|upper }}
                                </span>
                            </td>
                            <td class="px-3 sm:px-6 py-2 sm:py-4 hidden lg:table-cell">
                                <span class="px-2 sm:px-3 py-1 rounded-full text-xs font-medium {% if user.is_active %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {% if user.is_active %}Active{% else %}Inactive{% endif %}
                                </span>
                            </td>
                            <td class="px-3 sm:px-6 py-2 sm:py-4">
                                <div class="flex gap-1 sm:gap-4 text-xs sm:text-sm">
                                    {% if user_perms.can_update %}
                                        <a href="{% url 'frontend:edit-user' user.id %}" class="text-blue-600 hover:text-blue-900">Edit</a>
                                    {% endif %}

                                    {% if user_perms.can_delete %}
                                        <button onclick="deleteUser({{ user.id }})"
                                                class="text-red-600 hover:text-red-900 bg-none border-none cursor-pointer">
                                            Delete
                                        </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endwith %}
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" class="px-3 sm:px-6 py-8 text-center text-gray-500 text-xs sm:text-sm">
                                No users found. <a href="{% url 'frontend:create-user' %}" class="text-blue-600 hover:text-blue-900">Create one</a>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- API Access -->
    <div class="mt-6 sm:mt-8 bg-blue-50 rounded-lg p-4 sm:p-6">
        <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-2">API Access</h3>
        <p class="text-xs sm:text-sm text-gray-600 mb-4">Access users via REST API:</p>
        <code class="bg-gray-100 p-3 rounded text-sm text-gray-800">GET /api/users/</code>
    </div>
</div>

<script>
function deleteUser(userId) {
    showConfirmation(
        'Delete User',
        'Are you sure you want to delete this user? This action cannot be undone.',
        function() {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                             document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
            
            fetch('/users/' + userId + '/delete/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken || '{{ csrf_token }}'
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                return response.text().then(text => {
                    throw new Error(text || 'HTTP ' + response.status);
                });
            })
            .then(data => {
                if (data.success) {
                    showToast('User deleted successfully', 'success');
                    // Remove the row immediately for better UX
                    const row = document.querySelector('.user-row[data-id="' + userId + '"]');
                    if (row) {
                        row.style.transition = 'opacity 0.3s';
                        row.style.opacity = '0';
                        setTimeout(() => {
                            row.remove();
                            // Check if there are no more users
                            const remainingRows = document.querySelectorAll('.user-row');
                            if (remainingRows.length === 0) {
                                location.reload();
                            }
                        }, 300);
                    } else {
                        setTimeout(() => location.reload(), 1500);
                    }
                } else {
                    showToast('Error: ' + (data.error || 'Failed to delete user'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error deleting user: ' + error, 'error');
            });
        }
    );
}

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchUsers');
    const roleFilter = document.getElementById('roleFilter');
    const statusFilter = document.getElementById('statusFilter');
    const userRows = document.querySelectorAll('.user-row');

    function filterUsers() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedRole = roleFilter.value;
        const selectedStatus = statusFilter.value;

        userRows.forEach(row => {
            const username = row.cells[0].textContent.toLowerCase();
            const email = row.cells[1].textContent.toLowerCase();
            const fullName = row.cells[2].textContent.toLowerCase();
            const role = row.cells[3].textContent.trim();
            const status = row.cells[4].textContent.trim().toLowerCase();

            const matchesSearch = username.includes(searchTerm) || email.includes(searchTerm) || fullName.includes(searchTerm);
            const matchesRole = !selectedRole || role.includes(selectedRole);
            const matchesStatus = !selectedStatus || status.includes(selectedStatus);

            row.style.display = matchesSearch && matchesRole && matchesStatus ? '' : 'none';
        });
    }

    searchInput.addEventListener('keyup', filterUsers);
    roleFilter.addEventListener('change', filterUsers);
    statusFilter.addEventListener('change', filterUsers);
});
</script>
{% endblock %}

