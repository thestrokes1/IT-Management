{% extends "frontend/base.html" %}

{% block title %}Edit User - IT Management Platform{% endblock %}

{% block page_title %}Edit User{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6 sm:py-8">
    <!-- Header -->
    <div class="mb-6 sm:mb-8">
        <a href="{% url 'frontend:users' %}" class="text-blue-600 hover:text-blue-900 mb-4 inline-block text-xs sm:text-sm">‚Üê Back to Users</a>
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">Edit User: {{ user.username }}</h1>
        <p class="text-xs sm:text-base text-gray-600">Update user account information and permissions</p>
    </div>

    <!-- Form -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-8">
        {% if messages %}
            {% for message in messages %}
                <div class="mb-6 p-3 sm:p-4 {% if message.tags %}bg-{{ message.tags }}-50 border border-{{ message.tags }}-200{% else %}bg-blue-50 border border-blue-200{% endif %} rounded-lg text-xs sm:text-sm" role="alert">
                    <p>{{ message }}</p>
                </div>
            {% endfor %}
        {% endif %}

        {% if form.non_field_errors %}
        <div class="mb-6 p-3 sm:p-4 bg-red-50 border border-red-200 rounded-lg">
            <div class="text-red-800 text-xs sm:text-sm">
                {% for error in form.non_field_errors %}
                    <p class="font-medium">{{ error }}</p>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <form method="POST" class="space-y-6 sm:space-y-8">
            {% csrf_token %}

            <!-- Account Information Section -->
            <div class="border-b border-gray-200 pb-6 sm:pb-8">
                <h2 class="text-lg sm:text-xl font-semibold text-gray-900 mb-4 sm:mb-6">Account Information</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                    <!-- Username -->
                    <div class="md:col-span-2">
                        <label for="id_username" class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                            Username <span class="text-gray-500 font-normal">(Cannot be changed)</span>
                        </label>
                        <input 
                            type="text" 
                            id="id_username" 
                            value="{{ user.username }}"
                            class="w-full px-3 sm:px-4 py-2 text-xs sm:text-sm border border-gray-300 rounded-lg bg-gray-100 text-gray-600"
                            disabled
                        >
                    </div>

                    <!-- Email -->
                    <div class="md:col-span-2">
                        <label for="id_email" class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                            Email Address <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="email" 
                            id="id_email" 
                            name="email"
                            value="{{ form.email.value|default:user.email }}"
                            placeholder="Enter email address"
                            class="w-full px-3 sm:px-4 py-2 text-xs sm:text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition"
                            required
                        >
                        {% if form.email.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.email.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Change Password Section -->
                    <div class="md:col-span-2 p-3 sm:p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-xs sm:text-sm text-blue-900 mb-4">
                            <strong>Note:</strong> Leave password fields empty to keep the current password unchanged.
                        </p>

                        <!-- New Password -->
                        <div class="mb-4">
                            <label for="id_password" class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                                New Password
                            </label>
                            <input 
                                type="password" 
                                id="id_password" 
                                name="password"
                                placeholder="Enter new password (leave blank to keep current)"
                                class="w-full px-3 sm:px-4 py-2 text-xs sm:text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition"
                            >
                            <p class="text-xs text-gray-500 mt-1">Minimum 8 characters, include uppercase, lowercase, and numbers</p>
                            {% if form.password.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.password.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Confirm Password -->
                        <div>
                            <label for="id_password_confirm" class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                                Confirm New Password
                            </label>
                            <input 
                                type="password" 
                                id="id_password_confirm" 
                                name="password_confirm"
                                placeholder="Confirm new password"
                                class="w-full px-3 sm:px-4 py-2 text-xs sm:text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition"
                            >
                            {% if form.password_confirm.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.password_confirm.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Personal Information Section -->
            <div class="border-b border-gray-200 pb-6 sm:pb-8">
                <h2 class="text-lg sm:text-xl font-semibold text-gray-900 mb-4 sm:mb-6">Personal Information</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                    <!-- First Name -->
                    <div>
                        <label for="id_first_name" class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                            First Name
                        </label>
                        <input 
                            type="text" 
                            id="id_first_name" 
                            name="first_name"
                            value="{{ form.first_name.value|default:user.first_name }}"
                            placeholder="Enter first name"
                            class="w-full px-3 sm:px-4 py-2 text-xs sm:text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition"
                        >
                        {% if form.first_name.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.first_name.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Last Name -->
                    <div>
                        <label for="id_last_name" class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                            Last Name
                        </label>
                        <input 
                            type="text" 
                            id="id_last_name" 
                            name="last_name"
                            value="{{ form.last_name.value|default:user.last_name }}"
                            placeholder="Enter last name"
                            class="w-full px-3 sm:px-4 py-2 text-xs sm:text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition"
                        >
                        {% if form.last_name.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.last_name.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Permissions Section -->
            <div class="pb-6 sm:pb-8">
                <h2 class="text-lg sm:text-xl font-semibold text-gray-900 mb-4 sm:mb-6">Permissions & Status</h2>
                
                <div class="space-y-4 sm:space-y-6">
                    <!-- Role -->
                    <div>
                        <label for="id_role" class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                            Role <span class="text-red-500">*</span>
                        </label>
                        <select 
                            id="id_role" 
                            name="role"
                            class="w-full px-3 sm:px-4 py-2 text-xs sm:text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition"
                            required
                        >
                            <option value="">Select a role</option>
                            <option value="SUPERADMIN" {% if form.role.value|default:user.role == 'SUPERADMIN' %}selected{% endif %}>Super Administrator</option>
                            <option value="IT_ADMIN" {% if form.role.value|default:user.role == 'IT_ADMIN' %}selected{% endif %}>IT Administrator</option>
                            <option value="MANAGER" {% if form.role.value|default:user.role == 'MANAGER' %}selected{% endif %}>Manager</option>
                            <option value="TECHNICIAN" {% if form.role.value|default:user.role == 'TECHNICIAN' %}selected{% endif %}>Technician</option>
                            <option value="VIEWER" {% if form.role.value|default:user.role == 'VIEWER' %}selected{% endif %}>Viewer</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-2 leading-relaxed">
                            <strong>Super Admin:</strong> Full access | 
                            <strong>IT Admin:</strong> Manage users/system | 
                            <strong>Manager:</strong> Manage projects/tickets | 
                            <strong>Technician:</strong> Work on projects/tickets | 
                            <strong>Viewer:</strong> View-only
                        </p>
                        {% if form.role.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.role.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Is Active -->
                    <div class="flex items-start sm:items-center gap-2 sm:gap-3">
                        <input 
                            type="checkbox" 
                            id="id_is_active" 
                            name="is_active"
                            class="mt-1 sm:mt-0 rounded border-gray-300 text-blue-600 focus:ring-2 focus:ring-primary-500"
                            {% if form.is_active.value|default:user.is_active != False %}checked{% endif %}
                        >
                        <div>
                            <label for="id_is_active" class="text-xs sm:text-sm font-medium text-gray-700">
                                Active User
                            </label>
                            <p class="text-xs text-gray-500">User can log in and access the system</p>
                        </div>
                        {% if form.is_active.errors %}
                        <p class="text-red-500 text-xs">{{ form.is_active.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 pt-4">
                <button 
                    type="submit" 
                    id="saveBtn"
                    class="flex-1 bg-blue-600 text-white px-4 sm:px-6 py-2 sm:py-3 text-xs sm:text-base rounded-lg hover:bg-blue-700 font-medium transition"
                >
                    Save Changes
                </button>
                <a 
                    href="{% url 'frontend:users' %}" 
                    class="flex-1 bg-gray-200 text-gray-900 px-4 sm:px-6 py-2 sm:py-3 text-xs sm:text-base rounded-lg hover:bg-gray-300 font-medium transition text-center"
                >
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
// Attach submit listener to the form
document.querySelector('form').addEventListener('submit', function(e) {
    const saveBtn = document.getElementById('saveBtn');
    if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
    }
});

// Show toast notification if there's a success message
document.addEventListener('DOMContentLoaded', function() {
    const messages = document.querySelectorAll('[role="alert"]');
    if (messages.length > 0) {
        // Messages are already displayed by Django's messages framework
        // Auto-hide them after 5 seconds
        setTimeout(function() {
            messages.forEach(msg => {
                msg.style.opacity = '0';
                msg.style.transition = 'opacity 0.3s';
                setTimeout(() => msg.remove(), 300);
            });
        }, 5000);
    }
});
</script>
{% endblock %}
