{% extends 'frontend/base.html' %}

{% block title %}Activity Logs - IT Management Platform{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
<style>
    .log-timeline {
        position: relative;
        padding-left: 2rem;
    }
    .log-timeline::before {
        content: '';
        position: absolute;
        left: 0.5rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, #3b82f6, #e5e7eb);
    }
    html.dark .log-timeline::before {
        background: linear-gradient(to bottom, #3b82f6, #374151);
    }
    .log-entry {
        position: relative;
        margin-bottom: 1.5rem;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
        transition: box-shadow 0.2s;
    }
    html.dark .log-entry {
        background: #1f2937;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    .log-entry:hover {
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    html.dark .log-entry:hover {
        box-shadow: 0 4px 6px rgba(0,0,0,0.4);
    }
    .log-entry::before {
        content: '';
        position: absolute;
        left: -1.75rem;
        top: 1.5rem;
        width: 0.75rem;
        height: 0.75rem;
        border-radius: 50%;
        background: white;
        border: 2px solid #3b82f6;
        z-index: 1;
    }
    html.dark .log-entry::before {
        background: #1f2937;
        border: 2px solid #60a5fa;
    }
    .log-header {
        padding: 1rem 1.25rem;
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        cursor: pointer;
    }
    .log-icon {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    .log-content {
        flex: 1;
        min-width: 0;
    }
    .log-title-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    .log-title {
        font-weight: 600;
        color: #111827;
    }
    html.dark .log-title {
        color: #f3f4f6;
    }
    .log-actor {
        font-size: 0.875rem;
        color: #6b7280;
    }
    html.dark .log-actor {
        color: #9ca3af;
    }
    .log-meta {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
        flex-wrap: wrap;
    }
    .log-badges {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    .badge-severity {
        text-transform: uppercase;
    }
    .badge-intent {
        text-transform: capitalize;
    }
    .log-time {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-left: auto;
    }
    .log-details {
        border-top: 1px solid #e5e7eb;
        padding: 1rem 1.25rem;
        background: #f9fafb;
        display: none;
    }
    html.dark .log-details {
        border-top-color: #374151;
        background: #111827;
    }
    .log-details.expanded {
        display: block;
    }
    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    .detail-item {
        font-size: 0.875rem;
    }
    .detail-label {
        color: #6b7280;
        margin-bottom: 0.25rem;
    }
    html.dark .detail-label {
        color: #9ca3af;
    }
    .detail-value {
        color: #111827;
        font-weight: 500;
        word-break: break-word;
    }
    html.dark .detail-value {
        color: #f3f4f6;
    }
    .detail-value.json {
        font-family: monospace;
        font-size: 0.75rem;
        background: #e5e7eb;
        padding: 0.5rem;
        border-radius: 0.25rem;
        max-height: 200px;
        overflow: auto;
    }
    html.dark .detail-value.json {
        background: #374151;
        color: #f3f4f6;
    }
    .expand-icon {
        transition: transform 0.2s;
    }
    .log-details.expanded .expand-icon {
        transform: rotate(180deg);
    }
    .filter-container {
        max-width: 100%;
        overflow-x: auto;
    }
    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
        min-width: 100%;
    }
    .filter-item {
        min-width: 0;
    }
    /* Dark mode for filters */
    html.dark .filter-container .bg-white {
        background-color: #1f2937 !important;
    }
    html.dark .filter-container label {
        color: #f3f4f6;
    }
    /* Dark mode for table headers and cells */
    html.dark .bg-white.rounded-lg.shadow-md {
        background-color: #1f2937 !important;
    }
    html.dark .text-3xl,
    html.dark .text-4xl {
        color: #f3f4f6;
    }
    html.dark .text-gray-600 {
        color: #9ca3af !important;
    }
    /* Dark mode for security events table */
    html.dark table thead.bg-gray-100 {
        background-color: #374151 !important;
    }
    html.dark table thead.bg-gray-100 th {
        color: #f3f4f6;
    }
    html.dark table tbody.divide-y.divide-gray-200 td {
        color: #f3f4f6;
    }
    html.dark table tbody.divide-y.divide-gray-200 td.text-gray-600 {
        color: #9ca3af !important;
    }
    @media (max-width: 640px) {
        .filter-grid {
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }
        .log-header {
            flex-direction: column;
        }
        .log-time {
            margin-left: 0;
            margin-top: 0.5rem;
        }
        .detail-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 sm:py-8">
    <div class="mb-6 sm:mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-2">Activity Logs</h1>
        <p class="text-gray-600">View and search system activity events</p>
    </div>

    <!-- Filters -->
    <form method="GET" class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-6 filter-container">
        <div class="filter-grid">
            <div class="filter-item">
                <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Search logs..."
                       class="w-full px-4 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
            </div>

            <div class="filter-item">
                <label class="block text-sm font-medium text-gray-700 mb-2">User</label>
                <select name="username" class="w-full px-4 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                    <option value="">All Users</option>
                    {% for user in all_users %}
                        <option value="{{ user.username }}" {% if request.GET.username == user.username %}selected{% endif %}>{{ user.username }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-item">
                <label class="block text-sm font-medium text-gray-700 mb-2">Action</label>
                <select name="action" class="w-full px-4 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                    <option value="">All Actions</option>
                    <option value="TICKET_CREATED" {% if request.GET.action == 'TICKET_CREATED' %}selected{% endif %}>Ticket Created</option>
                    <option value="TICKET_UPDATED" {% if request.GET.action == 'TICKET_UPDATED' %}selected{% endif %}>Ticket Updated</option>
                    <option value="TICKET_ASSIGNED" {% if request.GET.action == 'TICKET_ASSIGNED' %}selected{% endif %}>Ticket Assigned</option>
                    <option value="ASSET_CREATED" {% if request.GET.action == 'ASSET_CREATED' %}selected{% endif %}>Asset Created</option>
                    <option value="USER_LOGIN" {% if request.GET.action == 'USER_LOGIN' %}selected{% endif %}>User Login</option>
                </select>
            </div>

            <div class="filter-item">
                <label class="block text-sm font-medium text-gray-700 mb-2">Severity</label>
                <select name="severity" class="w-full px-4 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                    <option value="">All Severities</option>
                    <option value="INFO" {% if request.GET.severity == 'INFO' %}selected{% endif %}>Info</option>
                    <option value="WARNING" {% if request.GET.severity == 'WARNING' %}selected{% endif %}>Warning</option>
                    <option value="ERROR" {% if request.GET.severity == 'ERROR' %}selected{% endif %}>Error</option>
                    <option value="SECURITY" {% if request.GET.severity == 'SECURITY' %}selected{% endif %}>Security</option>
                </select>
            </div>

            <div class="filter-item">
                <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
                <div class="flex gap-2">
                    <input type="date" name="start_date" value="{{ request.GET.start_date }}"
                           class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                    <input type="date" name="end_date" value="{{ request.GET.end_date }}"
                           class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                </div>
            </div>

            <div class="filter-item">
                <label class="block text-sm font-medium text-gray-700 mb-2">Â </label>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        <i class="fas fa-search mr-2"></i>Search
                    </button>
                    <a href="{% url 'frontend:logs' %}" class="flex-1 px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-lg hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 text-center">
                        <i class="fas fa-times mr-2"></i>Clear
                    </a>
                </div>
            </div>
        </div>
    </form>

    <!-- Activity Logs Timeline -->
    <div class="mb-8">
        <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4">Activity Timeline</h2>
        
        {% if log_entries %}
        <div class="log-timeline">
            {% for entry in log_entries %}
            <div class="log-entry" onclick="toggleDetails(this)">
                <!-- Header -->
                <div class="log-header">
                    <!-- Severity Icon -->
                    <div class="log-icon {{ entry.severity_color }}">
                        <i class="fas {{ entry.severity_icon }}"></i>
                    </div>
                    
                    <!-- Content -->
                    <div class="log-content">
                        <div class="log-title-row">
                            <span class="log-title">{{ entry.narrative }}</span>
                        </div>
                        
                        <div class="log-meta">
                            <!-- Badges -->
                            <div class="log-badges">
                                <span class="badge badge-severity {{ entry.severity_color }}">
                                    <i class="fas {{ entry.severity_icon }} mr-1"></i>
                                    {{ entry.severity_label }}
                                </span>
                                {% if entry.intent_label %}
                                <span class="badge badge-intent {{ entry.intent_color }}">
                                    {{ entry.intent_label }}
                                </span>
                                {% endif %}
                                {% if entry.entity_type %}
                                <span class="badge bg-gray-100 text-gray-800">
                                    {{ entry.entity_type|capfirst }}
                                </span>
                                {% endif %}
                            </div>
                            
                            <!-- Time -->
                            <span class="log-time">
                                {{ entry.formatted_timestamp }}
                                <span class="text-gray-400">({{ entry.time_ago }})</span>
                            </span>
                        </div>
                    </div>
                    
                    <!-- Expand Icon -->
                    <div class="expand-icon text-gray-400">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
                
                <!-- Expandable Details -->
                <div class="log-details" id="details-{{ forloop.counter }}">
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Actor</div>
                            <div class="detail-value">{{ entry.actor_name }}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Role</div>
                            <div class="detail-value">{{ entry.actor_role|default:"-" }}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Event Type</div>
                            <div class="detail-value">{{ entry.action_key }}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Entity</div>
                            <div class="detail-value">{{ entry.entity_display_name }}</div>
                        </div>
                        {% if entry.ip_address %}
                        <div class="detail-item">
                            <div class="detail-label">IP Address</div>
                            <div class="detail-value">{{ entry.ip_address }}</div>
                        </div>
                        {% endif %}
                        {% if entry.changes_summary %}
                        <div class="detail-item" style="grid-column: 1 / -1;">
                            <div class="detail-label">Changes</div>
                            <div class="detail-value">{{ entry.changes_summary }}</div>
                        </div>
                        {% endif %}
                        {% if entry.has_details and entry.changes_detail %}
                        <div class="detail-item" style="grid-column: 1 / -1;">
                            <div class="detail-label">Additional Data</div>
                            <pre class="detail-value json">{{ entry.changes_detail|pprint }}</pre>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-white rounded-lg shadow-md p-8 text-center">
            <div class="text-gray-400 mb-4">
                <i class="fas fa-clipboard-list text-4xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No Activity Logs Found</h3>
            <p class="text-gray-500">Try adjusting your filters or check back later.</p>
        </div>
        {% endif %}
    </div>

    <!-- Security Events Section -->
    <div class="mb-8">
        <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4">Security Events</h2>
        {% if security_events %}
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-100 border-b-2 border-gray-300">
                        <tr>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Detected</th>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Event Type</th>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Severity</th>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Status</th>
                            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Details</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for event in security_events %}
                        <tr class="hover:bg-gray-50 transition">
                            <td class="px-6 py-4 text-sm text-gray-600">
                                {{ event.detected_at|date:"M d, Y H:i" }}
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-900">{{ event.event_type }}</td>
                            <td class="px-6 py-4 text-sm">
                                <span class="px-3 py-1 rounded-full text-xs font-medium 
                                    {% if event.severity == 'CRITICAL' %}bg-red-100 text-red-800
                                    {% elif event.severity == 'HIGH' %}bg-orange-100 text-orange-800
                                    {% elif event.severity == 'MEDIUM' %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-blue-100 text-blue-800{% endif %}">
                                    {{ event.severity|upper }}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-sm">
                                <span class="px-3 py-1 rounded-full text-xs font-medium 
                                    {% if event.status == 'OPEN' %}bg-red-100 text-red-800
                                    {% elif event.status == 'INVESTIGATING' %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-green-100 text-green-800{% endif %}">
                                    {{ event.status|upper }}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-600">
                                {{ event.details|truncatewords:15 }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="bg-white rounded-lg shadow-md p-8 text-center">
            <div class="text-gray-400 mb-4">
                <i class="fas fa-shield-alt text-4xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No Security Events</h3>
            <p class="text-gray-500">System is running securely.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
function toggleDetails(element) {
    const details = element.querySelector('.log-details');
    if (details) {
        details.classList.toggle('expanded');
    }
}

// Initialize any flatpickr date inputs
document.addEventListener('DOMContentLoaded', function() {
    const dateInputs = document.querySelectorAll('input[type="date"]');
    dateInputs.forEach(input => {
        if (typeof flatpickr !== 'undefined') {
            flatpickr(input, {
                dateFormat: 'Y-m-d',
                maxDate: new Date().fp_incr(365)
            });
        }
    });
});
</script>
{% endblock %}
